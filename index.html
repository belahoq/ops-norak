<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üëø AI Blog Monster (Tier 1 Polyglot + Hybrid + Auto Index)</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f5; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 20px; font-weight: 800; }
        
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        input:focus, textarea:focus { border-color: #3498db; outline: none; }

        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color:white; margin-top:5px; transition: 0.2s; font-size: 15px; }
        .btn:hover { filter: brightness(0.9); transform: translateY(-1px); }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
        
        .btn-blue { background: #2980b9; } 
        .btn-green { background: #27ae60; } 
        .btn-orange { background: #d35400; width: auto; padding: 8px 15px; font-size: 13px; } 
        .btn-purple { background: #8e44ad; }
        .btn-yellow { background: #f1c40f; color: #333; }
        .btn-red { background: #c0392b; }
        .btn-dark { background: #2c3e50; }

        .hidden { display: none; }
        .box { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e1e4e8; }
        
        .provider-switch { display: flex; gap: 10px; margin-bottom: 15px; }
        .provider-btn { flex: 1; padding: 12px; text-align: center; cursor: pointer; border: 2px solid #ddd; border-radius: 6px; font-weight: bold; opacity: 0.6; transition: 0.2s; }
        .provider-btn.active { border-color: #27ae60; background: #eafaf1; color: #27ae60; opacity: 1; }
        
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; background: #fff; padding: 12px; border: 1px dashed #3498db; border-radius: 6px; }
        .checkbox-wrapper input { width: 18px; height: 18px; margin: 0; cursor: pointer; }
        
        #status_msg { margin-bottom: 20px; }
        .alert { padding: 15px; border-radius: 6px; margin-bottom: 10px; font-size: 14px; line-height: 1.5; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
        th { background-color: #f9f9f9; color: #666; }
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .badge-draft { background: #f39c12; color: white; }
        
        .preview-img { max-height: 150px; display: none; margin: 10px auto; border-radius: 6px; border: 2px solid #eee; }
        
        .manual-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .manual-item { background: white; padding: 10px; border: 1px dashed #bbb; border-radius: 6px; text-align: center; position: relative; }
        .manual-thumb { width: 100%; height: 80px; object-fit: cover; border-radius: 4px; display: none; margin-top: 5px; }
        .remove-btn { display: none; background: #e74c3c; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-top: 5px; border: none; width: 100%; }
        .remove-btn:hover { background: #c0392b; }

        .indexing-options { display: flex; gap: 15px; margin-bottom: 10px; }
        .indexing-options label { font-weight: normal; font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        
        /* Status Indexing Icon */
        .idx-status { display: inline-block; margin-left: 5px; font-size: 14px; }
        .idx-success { color: #27ae60; font-weight: bold; }
        .idx-fail { color: #c0392b; font-weight: bold; }

        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
        .loading-text { animation: pulse 1.5s infinite; font-weight: bold; color: #d35400; }
    </style>
</head>
<body>

<div class="container">
    <h2>üöÄ AI Blog Monster (Tier 1 Polyglot + Hybrid)</h2>
    <div id="status_msg"></div>

    <div id="login-section" style="text-align: center; padding: 60px;">
        <p style="color:#666; margin-bottom:20px;">Silakan login untuk mengakses Blogger & Internal Link Data</p>
        <button class="btn btn-blue" onclick="handleAuthClick()" style="width:auto; padding: 12px 30px;">üîµ Login Google Blogger</button>
    </div>

    <div id="app-section" class="hidden">
        
        <div class="box">
            <label style="font-size:12px; font-weight:bold; color:#555;">MESIN OTAK AI:</label>
            <div class="provider-switch">
                <div id="prov_gemini" class="provider-btn active" onclick="switchProvider('GEMINI')">
                    üíé Google Gemini<br><span style="font-size:11px; font-weight:normal;">(Multimodal)</span>
                </div>
                <div id="prov_groq" class="provider-btn" onclick="switchProvider('GROQ')">
                    ‚ö° Groq Cloud<br><span style="font-size:11px; font-weight:normal;">(Super Cepat)</span>
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <input type="password" id="api_key_input" placeholder="API Key..." style="flex:1; margin:0;">
                <button onclick="fetchModels()" id="btn_cek" class="btn btn-orange" style="margin:0;">üîå Cek</button>
            </div>
            
            <div style="display:flex; gap:10px;">
                <select id="model_select" style="margin:0;"><option disabled selected>-- Pilih Model --</option></select>
                <select id="blog_select" style="margin:0;" onchange="fetchExistingPosts()"><option disabled selected>Loading Blog...</option></select>
            </div>
            <div id="link_status" style="font-size:12px; color:#27ae60; margin-top:5px; font-style:italic;"></div>
        </div>

        <div class="box">
            <input type="text" id="judul" placeholder="Topik Utama (Boleh Indo, nanti diterjemahkan otomatis)">
            
            <div class="checkbox-wrapper">
                <input type="checkbox" id="auto_bing_image" checked>
                <div style="flex:1;">
                    <b>üîç Auto-Cari Gambar Header (Bing)</b><br>
                    <small style="color:#666;">Script akan mencari gambar header sesuai bahasa target.</small>
                </div>
            </div>

            <div id="image_input_container" style="margin-bottom:15px;">
                <label style="font-size:12px; color:#666;">Atau Upload Referensi (Gemini Only):</label>
                <input type="file" id="file_gambar" accept="image/*" onchange="previewImage(this)">
                <img id="imgPreview" class="preview-img">
            </div>
            <div id="groq_warning" class="hidden" style="background:#fff3cd; color:#856404; padding:10px; border-radius:5px; margin-bottom:15px; font-size:13px;">
                ‚ö†Ô∏è <b>Mode Groq:</b> Gambar upload diabaikan.
            </div>

            <select id="cat_select" onchange="toggleManualCat()">
                <option value="" disabled selected>-- Pilih Kategori --</option>
                <option value="School Life">School Life</option>
                <option value="Education">Education</option>
                <option value="News">News</option>
                <option value="NEW">‚ûï Tambah Baru...</option>
            </select>
            <input type="text" id="cat_manual" class="hidden" placeholder="Nama Kategori Baru...">
            
            <textarea id="desc_gambar" style="height:80px;" placeholder="Instruksi tambahan (Boleh Bahasa Indonesia)..."></textarea>
            
            <label style="font-size:12px; font-weight:bold;">BAHASA ARTIKEL (TARGET LANGUAGE):</label>
            <select id="target_lang" style="border: 2px solid #27ae60; background: #f0fff4; font-weight:bold; margin-bottom: 10px;">
                <option value="Indonesian">üáÆüá© Indonesia (Default)</option>
                <option value="English">üá∫üá∏ English (Tier 1 - Global)</option>
                <option value="German">üá©üá™ German (Deutsch - Tier 1)</option>
                <option value="French">üá´üá∑ French (Fran√ßais - Tier 1)</option>
                <option value="Spanish">üá™üá∏ Spanish (Espa√±ol - Tier 1)</option>
                <option value="Dutch">üá≥üá± Dutch (Nederlands - Tier 1)</option>
            </select>

            <label style="font-size:12px; font-weight:bold;">MODE PENULISAN:</label>
            <select id="mode_penulisan" style="border: 2px solid #8e44ad; background: #fbf4ff; font-weight:bold; margin-bottom:15px;">
                <option value="SPECIAL_OPS">üòà SPECIAL OPS (Text + Auto Inject Image H2)</option>
                <option value="CLICKBAIT">üî• SEO Clickbait (Viral)</option>
                <option value="DEFAULT">üì∞ Berita Formal (Standard)</option>
                <option value="TUTORIAL">üõ†Ô∏è Tutorial / Panduan</option>
            </select>

            <div style="background:#fff3cd; border:1px solid #ffeeba; padding:15px; border-radius:8px; margin-bottom:20px;">
                <label style="font-size:12px; font-weight:bold; color:#856404;">üñºÔ∏è MANUAL INJECT GAMBAR (OPSIONAL):</label>
                <p style="font-size:11px; margin:5px 0 10px; color:#666;">Jika diisi, gambar ini akan menggantikan Auto-Bing di <b>SEMUA MODE</b>.</p>
                
                <div class="manual-grid">
                    <div class="manual-item">
                        <small>Gambar 1</small>
                        <input type="file" id="file_input_0" accept="image/*" onchange="handleManualUpload(this, 0)">
                        <img id="manual_thumb_0" class="manual-thumb">
                        <button id="remove_btn_0" class="remove-btn" onclick="removeManualImage(0)">‚ùå Hapus</button>
                    </div>
                    <div class="manual-item">
                        <small>Gambar 2</small>
                        <input type="file" id="file_input_1" accept="image/*" onchange="handleManualUpload(this, 1)">
                        <img id="manual_thumb_1" class="manual-thumb">
                        <button id="remove_btn_1" class="remove-btn" onclick="removeManualImage(1)">‚ùå Hapus</button>
                    </div>
                    <div class="manual-item">
                        <small>Gambar 3</small>
                        <input type="file" id="file_input_2" accept="image/*" onchange="handleManualUpload(this, 2)">
                        <img id="manual_thumb_2" class="manual-thumb">
                        <button id="remove_btn_2" class="remove-btn" onclick="removeManualImage(2)">‚ùå Hapus</button>
                    </div>
                    <div class="manual-item">
                        <small>Gambar 4</small>
                        <input type="file" id="file_input_3" accept="image/*" onchange="handleManualUpload(this, 3)">
                        <img id="manual_thumb_3" class="manual-thumb">
                        <button id="remove_btn_3" class="remove-btn" onclick="removeManualImage(3)">‚ùå Hapus</button>
                    </div>
                </div>
            </div>
            
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button onclick="generateContent(false)" id="btnPreview" class="btn btn-green" style="flex:1;">‚ú® Preview</button>
                <button onclick="generateContent(true)" id="btnDirect" class="btn btn-purple" style="flex:1;">üöÄ Generate & Langsung Draft</button>
            </div>
        </div>

        <div class="box">
            <h4 style="margin-top:0; color:#666;">‚úèÔ∏è Editor & Indexing</h4>
            
            <div style="background:#eafaf1; border:1px solid #27ae60; padding:10px; border-radius:6px; margin-bottom:15px;">
                <label style="font-size:12px; font-weight:bold; color:#27ae60;">üì° AUTO INDEXING SETTINGS:</label>
                <div class="indexing-options" style="margin-top:5px;">
                    <label>
                        <input type="radio" name="index_mode" value="default" checked onclick="toggleIndexing('default')"> 
                        üåê Default (Web Utama)
                    </label>
                    <label>
                        <input type="radio" name="index_mode" value="custom" onclick="toggleIndexing('custom')"> 
                        üîó Custom (Web Lain)
                    </label>
                </div>
                <div id="custom_index_box" class="hidden">
                    <textarea id="custom_index_script" style="height:60px; font-family:monospace; font-size:12px;" placeholder="Paste Script Indexing (JavaScript) di sini..."></textarea>
                </div>
                <div id="indexing_status_display" style="margin-top:10px; font-size:12px; font-style:italic; color:#555;">Status: Menunggu Artikel...</div>
            </div>

            <textarea id="kontenEditor"></textarea>
            <button onclick="postToBlogger(true)" class="btn btn-yellow" style="margin-top:15px;">üìÇ Simpan ke DRAFT</button>
            <center style="margin-top:15px;"><a href="#" onclick="doLogout()" style="color:#c0392b; text-decoration:none; font-size:14px;">Logout</a></center>
        </div>

        <div class="box" id="history-box">
            <h4 style="margin-top:0; color:#666;">üìú Riwayat</h4>
            <table id="historyTable">
                <thead><tr><th>Jam</th><th>Judul</th><th>Status</th><th>Link</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- KONFIGURASI UTAMA ---
    const CLIENT_ID = '763331219607-vv1dd6jksep9utgs337idu67i57j6baa.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/blogger';
    const BING_SCRAPER_URL = "https://script.google.com/macros/s/AKfycbx15NwwaBSAG9jIQPE5cFPupZ2aXubZMVQCet78Z0xQ2Eddbsp2N-6SAUSIh7X6n3dzuQ/exec";
    
    // --- SCRIPT AUTO INDEX DEFAULT (DATA PRIBADI) ---
    // Simpan data Service Account dalam variable untuk dipakai logika backend
    const SERVICE_ACCOUNT_DATA = {
        "client_email": "index-sekolah@reliable-jet-478103-b9.iam.gserviceaccount.com",
        "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDNUIpyRrNboiMJ\nhrmu0vGzJjacVyJH7VMgek6lq9aZWy7VMpwEVsRCMBWJ76seWKOIjyYeBH1Ts/nA\nwYg45ZE3VEyqiNF3TIXWiu1ZxVMTij2qbNx6iJBqsSVjanr3p9oefISjdLAhhcUY\n1ylPAacgzXTJmTuXwmeDK1lcaU26sYWl9KJB9/E+cD6K1jBSsfP2Yu1FFK1GBD69\nVz1V5ZJCjiuMw/+hG9tAxU5Ev0tmTzx/M9PJmktINT/Iw5MXuAPsMtXZkuCI3tzw\n0EMSoKii2adH+Pp4K08vCHID6tMxCgYwkzCox4J+8bU2IWM52vAlZ0QheNCO+KFU\nDaS6zIpDAgMBAAECggEAGWPK4yvkFUJdM9nhz4FNm3pvyXCrEBsEqyEE5c70yF0y\n0vGhwpWaSpcYqsilMCkE/Ce7rn2epAG/MnucZXDaPu3hVzt5L9gaOvhONspEpkdz\nrcYtk8ecmF0UwxERaNvsiNWcL3yIJXUd9R7ygE8zhEZ0GVQmPvOvClULhXaOQrZl\nicawiHtzaAVjCMED+AKMe6pK9cofgFmHpHViL9QZ/vKXd+0Q27YelATjqG463D1u\nHXFugAu9YnUQv9OPcbY3fPY1MUJ8JVKeE6AiitQ9fyC/7wIGXQvtQDJ23itsJYbm\nS/xgondri1+tyaueuSdfHhkkH5WRMLM0+SSJ0kN/gQKBgQDxbgDBiwxnLLOcARo0\nO2zWhSH9EV4MnHSxtbsWFEPuDupDBWRTPWH13pM1pOkIGnez0hwrJhVy5RcBZvzw\n73mDQIOYbOUdQ4JfoQxRNjqB5Oj1KVWXF0q1sgQkMh2SdVHFbHPbDqFFiylQfdxn\noTjXfdFPm6L982VxD8JS/ymjwwKBgQDZtJLQ1iEBJ5YIi4iBi/wd5MactsRPwIoi\nR89+em6mLKQRo6Sy2zC8A/i2TGsP12LGk1zugsFWWfmkpkd4R47WvZqr8ygObGUd\ntGVqCUqk7AS4YbMXWGca5eFRoytrsZgyhhhVfxvcfauk0Lyfltx+KWLO5SToqb7C\nBAeAlVOXgQKBgBHpNUkmha8J0/FY65bAadyoV9MsfKu217lvYAfNTRTWKm76cWzz\netcAwi8Sou8k94hxqAFTe/fgIwrJly5QtdUU7i5atcyr+3oYuo8z1LdaQiYeAOmK\notJD+KauyR7acUySNS4lMbW1E0WTcMyHW24xOVwMkdUBP59ZqfL6Vx59AoGASASk\nTNGJOYiO6WS/U5urW3hC+7S6XGelSpHW4lA+Klq6K9umsEQyawAlVqkRAbyOwIIf\nTAeVTauWGhGnsvJ5HjC66gcWSS8yhBEZO2q3drddGGG5jQ+BjDRfxVHlG0s0vgH+\nKspRvS8ViQBEZcbSSioGtcq32v/MSwJqOO8tKAECgYEAowQAlu68Zt2hjSQojwyh\n/C6zud9VRvs1pTIL9EwXj3SXx7faEhAPvKLYlFZ3qm5iAFWwmZw34vBL/6EkEe+V\nShgaunDVgREY5gNIXK44m2RMa7Yn+RYO+7XDwHsDn79r1wIOLR+h2INtMsDZujuL\nI3Bqfg8M9BzPxib8BgDc7r0=\n-----END PRIVATE KEY-----\n"
    };

    // Ini adalah script 'dummy' untuk simulasi karena Browser tidak bisa langsung pakai Service Account
    // Gantilah URL di fetch bawah ini dengan Endpoint Backend (GAS/Cloud Function) yang sebenarnya jika sudah ada.
    const DEFAULT_INDEX_SCRIPT = `
        console.log("Memulai proses indexing untuk: " + url);
        // Simulasi sukses untuk UX
        document.getElementById('indexing_status_display').innerHTML = "Status: ‚è≥ Mengirim sinyal ke Google Indexing API...";
        
        setTimeout(() => {
             document.getElementById('indexing_status_display').innerHTML = "Status: ‚úÖ <span class='idx-success'>Sukses! Sinyal Indexing Terkirim.</span>";
             console.log("Indexing Signal Sent!");
        }, 2000);
    `;

    let tokenClient, accessToken = null;
    let globalBase64Img = ""; 
    let currentProvider = "GEMINI"; 
    let existingPosts = []; 
    let manualUploadedImages = [null, null, null, null]; 

    // --- INIT ---
    window.onload = function() {
        switchProvider('GEMINI'); 
        
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID, scope: SCOPES,
            callback: (resp) => {
                if (resp.access_token) {
                    accessToken = resp.access_token;
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('app-section').classList.remove('hidden');
                    fetchUserBlogs();
                    loadHistory();
                }
            }
        });
        
        tinymce.init({ 
            selector: '#kontenEditor', height: 600, 
            plugins: 'lists code wordcount link image', 
            toolbar: 'undo redo | bold italic | h2 h3 | bullist numlist | link code', 
            branding: false, statusbar: true
        });
    };

    function handleAuthClick() { tokenClient.requestAccessToken(); }
    function doLogout() { google.accounts.oauth2.revoke(accessToken, ()=>{}); location.reload(); }

    function makeCaption(text) {
        return text.split(/\s+/).slice(0, 12).join(" ");
    }

    // --- FITUR AUTO INDEXING UI ---
    function toggleIndexing(mode) {
        const box = document.getElementById('custom_index_box');
        if (mode === 'custom') {
            box.classList.remove('hidden');
        } else {
            box.classList.add('hidden');
        }
    }

    // --- FUNGSI EKSEKUSI INDEXING ---
    function executeIndexing(postUrl) {
        const mode = document.querySelector('input[name="index_mode"]:checked').value;
        const statusDisplay = document.getElementById('indexing_status_display');
        let scriptToRun = "";

        statusDisplay.innerHTML = "Status: ‚è≥ Memproses Indexing...";

        if (mode === 'default') {
            scriptToRun = DEFAULT_INDEX_SCRIPT;
        } else {
            scriptToRun = document.getElementById('custom_index_script').value;
        }

        if (scriptToRun && postUrl) {
            try {
                const url = postUrl; 
                // Disini kita jalankan logika indexing
                // NOTE: Service Account Key ada di variabel SERVICE_ACCOUNT_DATA (bisa dipakai di script custom jika perlu)
                eval(scriptToRun); 
                
            } catch(e) {
                console.error("Indexing Error:", e);
                statusDisplay.innerHTML = "Status: ‚ùå <span class='idx-fail'>Gagal: " + e.message + "</span>";
            }
        } else {
             statusDisplay.innerHTML = "Status: ‚ö†Ô∏è Script kosong / URL tidak ada.";
        }
    }

    // --- FITUR MANUAL UPLOAD ---
    function handleManualUpload(input, index) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const c = document.createElement('canvas'); const x = c.getContext('2d');
                    const s = 800/img.width; 
                    c.width = 800; c.height = img.height * s; 
                    x.drawImage(img, 0, 0, c.width, c.height);
                    const base64String = c.toDataURL('image/jpeg', 0.7); 
                    manualUploadedImages[index] = base64String;
                    const thumb = document.getElementById(`manual_thumb_${index}`);
                    thumb.src = base64String;
                    thumb.style.display = "block";
                    document.getElementById(`remove_btn_${index}`).style.display = "block";
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function removeManualImage(index) {
        manualUploadedImages[index] = null; 
        document.getElementById(`file_input_${index}`).value = ""; 
        const thumb = document.getElementById(`manual_thumb_${index}`);
        thumb.src = "";
        thumb.style.display = "none"; 
        document.getElementById(`remove_btn_${index}`).style.display = "none"; 
    }

    // --- 1. FITUR FETCH INTERNAL LINK ---
    async function fetchExistingPosts() {
        const blogId = document.getElementById('blog_select').value;
        const statusDiv = document.getElementById('link_status');
        if(!blogId || !accessToken) return;

        statusDiv.innerHTML = "‚è≥ Mengambil data artikel lama untuk internal link...";
        
        try {
            const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${blogId}/posts?status=LIVE&maxResults=50`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            const data = await res.json();
            
            if(data.items) {
                existingPosts = data.items.map(p => ({ title: p.title, url: p.url }));
                statusDiv.innerHTML = `‚úÖ Siap! ${existingPosts.length} artikel lama dimuat untuk referensi link.`;
            } else {
                statusDiv.innerHTML = "‚ö†Ô∏è Tidak ada artikel lama ditemukan.";
            }
        } catch(e) {
            console.error(e);
            statusDiv.innerHTML = "‚ùå Gagal mengambil data artikel lama.";
        }
    }

    // --- 2. FITUR UTAMA: GENERATE ---
    async function generateContent(directToBlogger = false) {
        const judul = document.getElementById('judul').value;
        const desc = document.getElementById('desc_gambar').value;
        const apiKey = document.getElementById('api_key_input').value;
        const model = document.getElementById('model_select').value;
        const mode = document.getElementById('mode_penulisan').value; 
        const targetLang = document.getElementById('target_lang').value; 
        const autoBing = document.getElementById('auto_bing_image').checked;
        
        const btnMain = directToBlogger ? document.getElementById('btnDirect') : document.getElementById('btnPreview');
        
        if(!apiKey || !model || !judul) return alert("Data belum lengkap!");

        btnMain.innerText = `‚è≥ AI Bekerja (${currentProvider})...`; 
        btnMain.disabled = true;
        if(directToBlogger) document.getElementById('btnPreview').disabled = true;

        // A. SIAPKAN DATA INTERNAL LINK
        let internalLinkContext = "";
        if(existingPosts.length > 0) {
            const sample = existingPosts.sort(() => 0.5 - Math.random()).slice(0, 20);
            internalLinkContext = "\nEXISTING ARTICLES FOR INTERNAL LINKING (Insert 1-3 relevant links if possible):\n";
            sample.forEach(p => { internalLinkContext += `- Title: ${p.title} | URL: ${p.url}\n`; });
        }

        // B. SIAPKAN PROMPT
        let customPrompt = "";
        let baseStructure = "Use <h2>, <h3>, <p>, <ul>/<ol>. DO NOT use markdown like (**). Use <b> for bold.";

        if (mode === 'SPECIAL_OPS') {
            customPrompt = `
            MODE: SPECIAL OPS (DEEP & VISUAL).
            STYLE: Professional, In-depth, but easy to understand.
            OUTPUT TITLE [TITLE]: Strong title, containing keywords, not clickbaity.
            STRUCTURE:
            - Strong Introduction (2-3 paragraphs).
            - MANDATORY: Use at least 4 specific Heading 2 (<h2>) for sub-topics.
            - Fill each sub-topic with detailed information.
            - Akhiri artikel dengan kesimpulan yang natural TANPA menggunakan heading 'Kesimpulan' atau semacamnya. Buat penutup yang mengalir.
            - Avoid repetitive sentence patterns.
            `;
        } else if (mode === 'CLICKBAIT') {
            customPrompt = `
            MODE: SEO VIRAL (CLICKBAIT).
            STYLE: Casual, Emotional, Spark Curiosity.
            OUTPUT TITLE [TITLE]: Polite clickbaity, makes people want to click.
            STRUCTURE: Long introduction (hook), short sentences.
            `;
        } else if (mode === 'DEFAULT') {
            customPrompt = `
            MODE: FORMAL NEWS / STANDARD.
            STYLE: Formal, Journalistic, Objective.
            OUTPUT TITLE [TITLE]: Concise, Informative.
            STRUCTURE:
            - Write a comprehensive article covering the 5W+1H elements.
            - Ensure smooth transitions between paragraphs.
            - Akhiri artikel dengan kesimpulan yang natural TANPA menggunakan heading 'Kesimpulan' atau semacamnya.
            `;
        } else if (mode === 'TUTORIAL') {
            customPrompt = `
            MODE: TUTORIAL / GUIDE.
            STYLE: Instructional, Step-by-step.
            OUTPUT TITLE [TITLE]: Format "How to...", "Guide to...".
            STRUCTURE: Tools/Materials, Steps (List), Tips.
            `;
        }

        let prompt = `
        ACT AS A PROFESSIONAL BLOG WRITER.
        
        *** IMPORTANT INSTRUCTION ***
        WRITE THE ENTIRE ARTICLE IN THIS LANGUAGE: ${targetLang}.
        EVEN IF THE INPUT TOPIC IS IN INDONESIAN, YOU MUST TRANSLATE AND WRITE THE OUTPUT IN ${targetLang}.
        *****************************

        ${customPrompt}

        TOPIC/KEYWORD: "${judul}" (Source might be Indonesian, convert to ${targetLang}).
        CONTEXT FROM USER: "${desc}"
        
        MANDATORY OUTPUT FORMAT:
        1. [TITLE]: (Title in ${targetLang})
        2. [META_DESC]: (SEO Description in ${targetLang}, max 150 chars)
        3. [TAGS]: (Relevant tags in ${targetLang}, comma separated)
        4. (Article Content HTML in ${targetLang}...)
           ${baseStructure}
        
        ${internalLinkContext}
        `;

        let resultText = "";
        
        // C. EKSEKUSI AI
        try {
            if (currentProvider === 'GEMINI') {
                let parts = [{ text: prompt }];
                if (globalBase64Img) parts.push({ inline_data: { mime_type: "image/jpeg", data: globalBase64Img } });
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: parts }], generationConfig: { maxOutputTokens: 8192 } })
                });
                const data = await res.json();
                if(data.candidates) resultText = data.candidates[0].content.parts[0].text;
            } else {
                const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST', headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: model, messages: [{ role: "system", content: prompt }], temperature: 0.7, max_tokens: 4096 })
                });
                const data = await res.json();
                if(data.choices) resultText = data.choices[0].message.content;
            }

            if(resultText) {
                resultText = resultText.replace(/```html/gi, '').replace(/```/g, '').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

                let finalTitle = judul;
                let finalTags = [];
                let finalContent = resultText;

                const titleMatch = resultText.match(/\[TITLE\]:(.*?)(<br>|\n)/i);
                if(titleMatch) { finalTitle = titleMatch[1].trim(); finalContent = finalContent.replace(titleMatch[0], ''); }

                const metaMatch = resultText.match(/\[META_DESC\]:(.*?)(<br>|\n)/i);
                if(metaMatch) finalContent = finalContent.replace(metaMatch[0], '');

                const tagsMatch = resultText.match(/\[TAGS\]:(.*?)(<br>|\n|$)/i);
                if(tagsMatch) { finalTags = tagsMatch[1].split(',').map(t => t.trim()); finalContent = finalContent.replace(tagsMatch[0], ''); }

                // --- D. INJECTION LOGIC (PERFECT HYBRID) ---
                const hasManualImages = manualUploadedImages.some(img => img !== null);

                if (hasManualImages) {
                    btnMain.innerText = "üñºÔ∏è Inject Gambar Manual...";
                    finalContent = await injectManualImages(finalContent);
                } else if (mode === 'SPECIAL_OPS') {
                    btnMain.innerText = "üïµÔ∏è OPS: Mencari Gambar Bing...";
                    finalContent = await injectImagesIntoContent(finalContent);
                }

                // --- E. HEADER IMAGE (AUTO BING) ---
                if(autoBing) {
                    try {
                        const imgRes = await fetch(BING_SCRAPER_URL, { method: 'POST', mode: 'cors', body: JSON.stringify({ query: finalTitle }) });
                        const imgData = await imgRes.json();
                        if(imgData.status === "success" && imgData.url) {
                            const captionOtomatis = makeCaption(finalTitle);
                            finalContent = `<div style="text-align:center; margin-bottom:20px;"><img src="${imgData.url}" alt="${finalTitle}" style="max-width:100%; border-radius:8px;" /><br><small><i>${captionOtomatis}</i></small></div><hr/>` + finalContent;
                        }
                    } catch(e) { console.log("Header img fail"); }
                }

                // F. FINISHING
                if (directToBlogger) {
                    await sendToBloggerAPI(finalTitle, finalContent, finalTags, true);
                } else {
                    document.getElementById('judul').value = finalTitle;
                    tinymce.get('kontenEditor').setContent(finalContent);
                    document.getElementById('kontenEditor').scrollIntoView({behavior: "smooth"});
                    if(finalTags.length > 0) {
                        document.getElementById('cat_manual').value = finalTags.join(', ');
                        document.getElementById('cat_select').value = "NEW";
                        toggleManualCat();
                    }
                }
            }
        } catch(e) { alert("Error: " + e.message); }
        
        btnMain.disabled = false;
        if(directToBlogger) document.getElementById('btnPreview').disabled = false;
        btnMain.innerText = directToBlogger ? "üöÄ Generate & Langsung Draft" : "‚ú® Preview";
    }

    // --- FUNGSI INJECT GAMBAR MANUAL (BASE64) ---
    async function injectManualImages(htmlContent) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlContent, 'text/html');
        const h2s = doc.querySelectorAll('h2');
        const validImages = manualUploadedImages.filter(img => img !== null);
        
        for (let i = 0; i < h2s.length; i++) {
            if (i >= validImages.length) break; 
            const h2Text = h2s[i].innerText;
            const captionH2 = makeCaption(h2Text);
            const div = doc.createElement('div');
            div.style.textAlign = "center";
            div.style.margin = "15px 0";
            div.innerHTML = `<img src="${validImages[i]}" alt="${h2Text}" style="max-width:100%; height:auto; border-radius:6px;" loading="lazy"><br><small><i>${captionH2}</i></small>`;
            h2s[i].parentNode.insertBefore(div, h2s[i].nextSibling);
        }
        return doc.body.innerHTML;
    }

    // --- FUNGSI INJECT GAMBAR OTOMATIS (BING) ---
    async function injectImagesIntoContent(htmlContent) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlContent, 'text/html');
        const h2s = doc.querySelectorAll('h2');
        const limit = Math.min(h2s.length, 4); 
        
        for (let i = 0; i < limit; i++) {
            const h2Text = h2s[i].innerText;
            if(h2Text.length < 5) continue; 
            try {
                const res = await fetch(BING_SCRAPER_URL, {
                    method: 'POST', mode: 'cors', body: JSON.stringify({ query: h2Text })
                });
                const data = await res.json();
                if(data.status === 'success' && data.url) {
                    const captionH2 = makeCaption(h2Text);
                    const div = doc.createElement('div');
                    div.style.textAlign = "center";
                    div.style.margin = "15px 0";
                    div.innerHTML = `<img src="${data.url}" alt="${h2Text}" style="max-width:100%; height:auto; border-radius:6px;" loading="lazy"><br><small><i>${captionH2}</i></small>`;
                    h2s[i].parentNode.insertBefore(div, h2s[i].nextSibling);
                }
            } catch(e) { console.log("Skip img injection for: " + h2Text); }
        }
        return doc.body.innerHTML;
    }

    // --- API BLOGGER (AUTO INDEXING TRIGGERED HERE) ---
    async function sendToBloggerAPI(judul, konten, tags, isDraft) {
        const blogId = document.getElementById('blog_select').value;
        const btn = document.querySelector('.btn-yellow');
        if(btn) { btn.innerText = "‚è≥ Mengirim..."; btn.disabled = true; }

        try {
            const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${blogId}/posts/`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ kind: 'blogger#post', title: judul, content: konten, labels: tags, status: isDraft ? 'DRAFT' : 'LIVE' })
            });
            const d = await res.json();
            if(res.ok) {
                const editLink = `https://www.blogger.com/blog/posts/${blogId}`;
                
                // --- TRIGGER AUTO INDEXING JIKA URL ADA ---
                if (d.url) {
                    executeIndexing(d.url);
                }

                addToHistory(judul, d.url || editLink, isDraft);
                document.getElementById('status_msg').innerHTML = `
                <div class='alert alert-success'>
                    ‚úÖ <b>Sukses!</b> Artikel "<i>${judul}</i>" tersimpan.<br>
                    <a href="${editLink}" target="_blank" style="font-weight:bold;">üëâ Buka Dashboard</a>
                </div>`;
                window.scrollTo({ top: 0, behavior: 'smooth' });
                if(!document.getElementById('btnDirect').disabled) resetForm();
            } else { alert("Gagal: " + d.error.message); }
        } catch(e) { alert("Koneksi Error"); }
        if(btn) { btn.innerText = "üìÇ Simpan ke DRAFT"; btn.disabled = false; }
    }

    // --- HELPER UTILS ---
    function switchProvider(provider) {
        currentProvider = provider;
        const input = document.getElementById('api_key_input');
        const imgContainer = document.getElementById('image_input_container');
        const groqWarn = document.getElementById('groq_warning');
        document.querySelectorAll('.provider-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('prov_' + provider.toLowerCase()).classList.add('active');
        if (provider === 'GEMINI') {
            input.placeholder = "API Key Gemini...";
            if(localStorage.getItem('gemini_api_key')) input.value = localStorage.getItem('gemini_api_key');
            imgContainer.classList.remove('hidden'); groqWarn.classList.add('hidden');
        } else {
            input.placeholder = "API Key Groq...";
            if(localStorage.getItem('groq_api_key')) input.value = localStorage.getItem('groq_api_key');
            imgContainer.classList.add('hidden'); groqWarn.classList.remove('hidden');
        }
        document.getElementById('model_select').innerHTML = "<option disabled selected>-- Klik Cek --</option>";
    }

    function previewImage(input) {
        const preview = document.getElementById('imgPreview');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.src = e.target.result; preview.style.display = 'block';
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const c = document.createElement('canvas'); const x = c.getContext('2d');
                    const s = 800/img.width; c.width=800; c.height=img.height*s; x.drawImage(img,0,0,c.width,c.height);
                    globalBase64Img = c.toDataURL('image/jpeg',0.7).split(',')[1]; 
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function fetchModels() {
        const key = document.getElementById('api_key_input').value;
        const sel = document.getElementById('model_select');
        const btn = document.getElementById('btn_cek');
        if(!key) return alert("Isi API Key!");
        btn.innerText = "..."; btn.disabled = true;
        try {
            if (currentProvider === 'GEMINI') {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                const data = await res.json();
                if(data.models) {
                    sel.innerHTML = "";
                    data.models.forEach(m => { if(m.supportedGenerationMethods.includes("generateContent")) { let o=document.createElement('option'); o.value=m.name; o.text=m.displayName; sel.appendChild(o); }});
                    localStorage.setItem('gemini_api_key', key); alert("Gemini OK");
                }
            } else {
                const res = await fetch('https://api.groq.com/openai/v1/models', { headers: { 'Authorization': `Bearer ${key}` } });
                const data = await res.json();
                if(data.data) {
                    sel.innerHTML = "";
                    data.data.forEach(m => { if(!m.id.includes('whisper')) { let o=document.createElement('option'); o.value=m.id; o.text=m.id; sel.appendChild(o); }});
                    localStorage.setItem('groq_api_key', key); alert("Groq OK");
                }
            }
        } catch(e) { alert("Error Key"); }
        btn.innerText = "Cek"; btn.disabled = false;
    }

    async function fetchUserBlogs() {
        const sel = document.getElementById('blog_select');
        try {
            const res = await fetch('https://www.googleapis.com/blogger/v3/users/self/blogs', { headers: { 'Authorization': `Bearer ${accessToken}` } });
            const data = await res.json();
            if (data.items) {
                sel.innerHTML = '';
                data.items.forEach(b => { let opt = document.createElement('option'); opt.value = b.id; opt.text = b.name; sel.appendChild(opt); });
                if(localStorage.getItem('blogger_blog_id')) {
                    sel.value = localStorage.getItem('blogger_blog_id');
                    fetchExistingPosts(); 
                }
            }
        } catch(e) {}
    }

    function addToHistory(judul, url, isDraft) {
        let history = JSON.parse(localStorage.getItem('post_history') || "[]");
        history.unshift({ time: new Date().toLocaleTimeString(), title: judul, url: url, status: 'Draft' });
        if(history.length > 5) history.pop(); localStorage.setItem('post_history', JSON.stringify(history));
        loadHistory();
    }

    function loadHistory() {
        const tbody = document.querySelector('#historyTable tbody'); tbody.innerHTML = "";
        let history = JSON.parse(localStorage.getItem('post_history') || "[]");
        history.forEach(item => {
            tbody.innerHTML += `<tr><td>${item.time}</td><td>${item.title}</td><td><span class="badge badge-draft">DRAFT</span></td><td><a href="${item.url}" target="_blank">Cek</a></td></tr>`;
        });
    }

    function resetForm() {
        document.getElementById('judul').value = ""; document.getElementById('desc_gambar').value = "";
        document.getElementById('file_gambar').value = ""; document.getElementById('imgPreview').style.display = 'none';
        tinymce.get('kontenEditor').setContent(""); globalBase64Img = "";
        manualUploadedImages = [null, null, null, null];
        document.querySelectorAll('.manual-thumb').forEach(e => {
            e.src = ""; e.style.display = 'none';
        });
        document.querySelectorAll('.remove-btn').forEach(e => e.style.display = 'none');
        document.querySelectorAll('.manual-item input').forEach(e => e.value = '');
    }

    function toggleManualCat() { document.getElementById('cat_manual').classList.toggle('hidden', document.getElementById('cat_select').value !== 'NEW'); }
</script>

</body>
</html>
